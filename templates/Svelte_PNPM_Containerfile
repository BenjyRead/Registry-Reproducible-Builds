# -- Build Stage --
FROM {{.NODE_IMAGE}} AS build

RUN apk add --no-cache git pnpm

WORKDIR /app

# Since tags can be moved, we fetch the specific commit instead.
RUN git clone {{.REPO_URL}} .
RUN git fetch --depth 1 origin {{.COMMIT_SHA}}
RUN git checkout {{.COMMIT_SHA}}

RUN pnpm install --frozen-lockfile
RUN pnpm build --filter ./packages/svelte

# pnpm pack generate tgz file
RUN cd packages/svelte && pnpm pack --pack-destination /out

# Testing diffoscope works
# RUN printf '\n' >> /tmp/svelte-5.48.2.tgz

# -- Pull Stage --
FROM {{.NODE_IMAGE}} AS official

RUN apk add --no-cache wget

RUN mkdir -p /out
RUN wget {{.OFFICIAL_TGZ_URL}} -O /out/official.tgz

# -- Compare Stage --
FROM {{.ALPINE_IMAGE}}

RUN apk add --no-cache diffoscope

COPY --from=build /out/{{.TGZ_FILENAME}} /tmp/build.tgz
COPY --from=official /out/official.tgz /tmp/official.tgz

CMD sh -c "set -x; diffoscope /tmp/build.tgz /tmp/official.tgz"
